# Makefile
#
# Generated by phxrpc_pb2server from mqttbroker.proto
#
#

include ../../../makefile.mk

LIB_MQTT_OBJS = mqtt/mqtt_msg.o mqtt/mqtt_msg_handler.o mqtt/mqtt_protocol.o \
		mqtt/mqtt_msg_handler_factory.o mqtt/mqtt_session.o mqtt/mqtt_packet_id.o

SVR_OBJS = mqttbroker_service_impl.o \
		publish/publish_mgr.o \
		publish/publish_memory.o \
		mqttbroker_logic.o \
		mqttbroker.pb.o \
		event_loop_server_config.o \
		event_loop_server.o \
		server_mgr.o \
		phxrpc_mqttbroker_service.o \
		phxrpc_mqttbroker_dispatcher.o \
		mqttbroker_server_config.o \
		mqttbroker_main.o

SAMPLE_SVR_OBJS = sample/mqttbroker_service_impl.o \
		publish/publish_mgr.o \
		publish/publish_memory.o \
		mqttbroker.pb.o \
		event_loop_server_config.o \
		event_loop_server.o \
		server_mgr.o \
		phxrpc_mqttbroker_service.o \
		phxrpc_mqttbroker_dispatcher.o \
		mqttbroker_server_config.o \
		mqttbroker_main.o

CLI_OBJS = mqttbroker.pb.o \
		mqttbroker_client.o \
		mqttbroker_client_uthread.o \
		phxrpc_mqttbroker_stub.o

TARGETS = libmqttbroker_client.a mqttbroker_main mqttbroker_tool_main

all: $(TARGETS)

mqttbroker_main: $(SVR_OBJS) $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L../../../lib/ \
			-lphxqueue_phxrpc_logic_mqtt -lphxqueue_phxrpc_producer -lstore_client -llock_client \
			-lphxqueue_phxrpc_plugin -lphxqueue_phxrpc_comm \
			-lphxqueue_producer -lphxqueue_config \
			-lphxqueue_comm -lphxqueue_plugin $(LDFLAGS) -o $@

sample_mqttbroker_main: $(SAMPLE_SVR_OBJS) $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L../../../lib/ \
			-lphxqueue_phxrpc_logic_mqtt -lphxqueue_phxrpc_producer -lstore_client -llock_client \
			-lphxqueue_phxrpc_plugin -lphxqueue_phxrpc_comm \
			-lphxqueue_producer -lphxqueue_config \
			-lphxqueue_comm -lphxqueue_plugin $(LDFLAGS) -o $@

libmqttbroker_client.a: $(CLI_OBJS) $(LIB_MQTT_OBJS)
	$(AR) $@ $^

mqttbroker_tool_main: phxrpc_mqttbroker_tool.o mqttbroker_tool_impl.o mqttbroker_tool_main.o $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L. -lphxqueue_phxrpc_logic_mqtt -lmqttbroker_client -lphxqueue_comm $(LDFLAGS) -o $@

test_publish_mgr: test_publish_mgr.o publish/publish_mgr.o publish/publish_memory.o server_mgr.o \
		mqttbroker_server_config.o event_loop_server_config.o event_loop_server.o $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L../../../lib/ \
			-lphxqueue_phxrpc_logic_mqtt -lphxqueue_phxrpc_producer -lstore_client -llock_client \
			-lphxqueue_phxrpc_plugin -lphxqueue_phxrpc_comm \
			-lphxqueue_producer -lphxqueue_config \
			-lphxqueue_comm -lphxqueue_plugin $(LDFLAGS) -o $@

%.pb.o: %.pb.cc
	$(CXX) $(CXXFLAGS) -o $@ -c $< -I$(PROTOBUF_INCLUDE_DIR) -I$(PHXRPC_INCLUDE_DIR) \
			-I$(PHXQUEUE_INCLUDE_DIR) -I.

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -o $@ -c $< -I$(GLOG_INCLUDE_DIR) -I$(PROTOBUF_INCLUDE_DIR) \
			-I$(LEVELDB_INCLUDE_DIR) -I$(LIBCO_INCLUDE_DIR) -I$(PHXRPC_INCLUDE_DIR) \
			-I$(PHXPAXOS_INCLUDE_DIR) -I$(PHXPAXOS_PLUGIN_INCLUDE_DIR) -I$(PHXQUEUE_INCLUDE_DIR)

########## message ##########

pb: mqttbroker.pb.cc mqttbroker.pb.h

mqttbroker.pb.cc: mqttbroker.pb.h

mqttbroker.pb.h: mqttbroker.proto
	$(PROTOBUF_BIN_DIR)/protoc $^ --proto_path=$(PHXRPC_INCLUDE_DIR) --proto_path=$(PHXQUEUE_INCLUDE_DIR) $(PBFLAGS)

########## client ##########

phxrpc_mqttbroker_stub.cpp: phxrpc_mqttbroker_stub.h
phxrpc_mqttbroker_stub.o: phxrpc_mqttbroker_stub.h
mqttbroker_client.cpp: phxrpc_mqttbroker_stub.h
mqttbroker_client.o: phxrpc_mqttbroker_stub.h
mqttbroker_client_uthread.cpp: phxrpc_mqttbroker_stub.h
mqttbroker_client_uthread.o: phxrpc_mqttbroker_stub.h

########## service ##########

phxrpc_mqttbroker_service.cpp: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_service.o: phxrpc_mqttbroker_service.h
mqttbroker_service_impl.cpp: phxrpc_mqttbroker_service.h
mqttbroker_service_impl.o: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_dispatcher.cpp: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_dispatcher.o: phxrpc_mqttbroker_service.h

########## tool ##########

phxrpc_mqttbroker_tool.cpp: phxrpc_mqttbroker_tool.h
phxrpc_mqttbroker_tool.o: phxrpc_mqttbroker_tool.h
mqttbroker_tool_impl.cpp: phxrpc_mqttbroker_tool.h
mqttbroker_tool_impl.o: phxrpc_mqttbroker_tool.h
mqttbroker_tool_main.cpp: phxrpc_mqttbroker_tool.h
mqttbroker_tool_main.o: phxrpc_mqttbroker_tool.h

clean:
	@($(RM) $(TARGETS))
	@($(RM) *.o)
	@($(RM) *.pb.*)
	@($(RM) mqtt/*.o)
	@($(RM) publish/*.o)
	@($(RM) sample/*.o)

