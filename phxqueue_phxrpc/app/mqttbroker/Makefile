# Makefile
#
# Generated by phxrpc_pb2server from mqttbroker.proto
#
#

include ../../../makefile.mk

LDFLAGS := -L$(PHXRPC_ROOT)/lib -lphxrpc $(LDFLAGS)

LIB_MQTT_OBJS = mqtt/mqtt_msg.o mqtt/mqtt_msg_handler.o mqtt/mqtt_protocol.o \
		mqtt/mqtt_msg_handler_factory.o mqtt/mqtt_session.o mqtt/mqtt_packet_id.o

SVR_OBJS = mqttbroker.pb.o \
		event_loop_server_config.o \
		event_loop_server.o \
		server_mgr.o \
		phxrpc_mqttbroker_service.o \
		phxrpc_mqttbroker_dispatcher.o \
		mqttbroker_server_config.o \
		mqttbroker_main.o

all: mqttbroker_main

mqttbroker_main: mqttbroker_service_impl.o $(SVR_OBJS) $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L$(PHXRPC_LIB_DIR) -lphxrpc  -L../../../lib/ -lphxqueue_phxrpc_producer -lstore_client -L ../lock/ -llock_client -lphxqueue_phxrpc_plugin -lphxqueue_phxrpc_comm \
	-lphxqueue_producer -lphxqueue_store -lphxqueue_config -lphxqueue_comm -lphxqueue_plugin $(LDFLAGS) -o $@

sample_mqttbroker_main: sample/mqttbroker_service_impl.o $(SVR_OBJS) $(LIB_MQTT_OBJS)
	$(LINKER) $^ -L$(PHXQUEUE_LIB_DIR) -L$(PHXRPC_LIB_DIR) -lphxrpc  -L../../../lib/ -lphxqueue_phxrpc_producer -lstore_client -L ../lock/ -llock_client -lphxqueue_phxrpc_plugin -lphxqueue_phxrpc_comm \
	-lphxqueue_producer -lphxqueue_store -lphxqueue_config -lphxqueue_comm -lphxqueue_plugin $(LDFLAGS) -o $@

%.pb.o: %.pb.cc
	$(CXX) $(CXXFLAGS) -o $@ -c $< -I$(PROTOBUF_INCLUDE_DIR) -I$(PHXRPC_INCLUDE_DIR) \
			-I$(PHXQUEUE_INCLUDE_DIR) -I.

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -o $@ -c $< -I$(GLOG_INCLUDE_DIR) -I$(PROTOBUF_INCLUDE_DIR) \
			-I$(LEVELDB_INCLUDE_DIR) -I$(LIBCO_INCLUDE_DIR) -I$(PHXRPC_INCLUDE_DIR) \
			-I$(PHXPAXOS_INCLUDE_DIR) -I$(PHXPAXOS_PLUGIN_INCLUDE_DIR) -I$(PHXQUEUE_INCLUDE_DIR)

########## message ##########

pb: mqttbroker.pb.cc mqttbroker.pb.h

mqttbroker.pb.cc: mqttbroker.pb.h

mqttbroker.pb.h: mqttbroker.proto
	$(PROTOBUF_BIN_DIR)/protoc $^ --proto_path=$(PHXRPC_INCLUDE_DIR) --proto_path=$(PHXQUEUE_INCLUDE_DIR) $(PBFLAGS)

########## service ##########

phxrpc_mqttbroker_service.cpp: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_service.o: phxrpc_mqttbroker_service.h
mqttbroker_service_impl.cpp: phxrpc_mqttbroker_service.h
mqttbroker_service_impl.o: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_dispatcher.cpp: phxrpc_mqttbroker_service.h
phxrpc_mqttbroker_dispatcher.o: phxrpc_mqttbroker_service.h

clean:
	@($(RM) $(TARGETS))
	@($(RM) *.o)
	@($(RM) *.pb.*)
	@($(RM) mqtt/*.o)

